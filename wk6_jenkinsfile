// week5 example uses Jenkin's "scripted" syntax, as opposed to its "declarative" syntax
// see: https://www.jenkins.io/doc/book/pipeline/syntax/#scripted-pipeline
// Defines a Kubernetes pod template that can be used to create nodes.
podTemplate(
  podRetention: onFailure(),
  containers: [
  containerTemplate(
    name: 'gradle', image: 'gradle:6.3-jdk14', command: 'sleep', args: '30d'
  ),
]) {
    node(POD_LABEL) {
      stage('Run pipeline against a gradle project') {
            // "container" Selects a container of the agent pod so that all shell steps are
            // executed in that container.
            container('gradle') {
                stage('gradlew executable') {
	              sh "chmod +x gradlew"
                      
		}


          stage("Unit test") {
                  when {
                    not { branch 'main' }
                }

               steps {
                    sh "./gradlew test"
               }
          }


                stage('Code coverage') {
			when {
				branch 'main'
		            }

                    steps {
		          sh '''
                          pwd
                          cd Chapter08/sample1
                          ./gradlew jacocoTestCoverageVerification
                          ./gradlew jacocoTestReport
                          '''
                    // from the HTML publisher plugin
                    // https://www.jenkins.io/doc/pipeline/steps/htmlpublisher/
                    publishHTML(target: [
                      reportDir: 'Chapter08/sample1/build/reports/tests/test',
                      reportFiles: 'index.html',
                      reportName: 'JaCoCo Report'
                      ])
		   }
                }
                

                stage('Jacoco Checkstyle') {
		  when { 
		    not { branch 'main' }
		}
		steps {
                        sh '''
                          pwd
                          cd Chapter08/sample1
                          ./gradlew checkstyleMain
                          '''
                    publishHTML(target: [
                     reportDir: 'Chapter08/sample1/build/reports/checkstyle',
                     reportFiles: 'main.html',
                     reportName: "Jacoco Checkstyle"
                    ])
                }
	      }



            }
        }
    }
}
